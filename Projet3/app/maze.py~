#!/usr/bin/env python3

import pygame
from pygame.locals import *
import os
import random


#initialization of the pygame library


class Labyrinth:
    """Initialization of the graphic interface by using the resources
    located in the folder 'resources'. The size of the graphic interface is
    defined by the size of the labyrinth (here 15*15 sprites) and the size
    of the sprites (here 32*32).

    When the class is called, the 3 objects needed for the victory are randomly
    place on the labyrinth, then the graphic interfac is displayed, but it has to be
    in a loop (usually while), or else it will just appear briefly on the screen.
    """


    def __init__(self):
        """Printing of the graphic interface using the images loaded from the resources folder"""

        # Generation of labyrinth as a 2d list :
        os.chdir("../../resources/map")
        with open("labyrinth.txt", "r") as tmp:
            raw_labyrinth = tmp.read()
        self.no_row = 0
        self.no_column = 0
        self.labyrinth, self.no_row, self.no_column = load_labyrinth(raw_labyrinth)

        # Calculation of the number of rows and columns


        # The labyrinth is updated with the three objects placed randomly
        self.labyrinth = place_objects(self.labyrinth, self.no_row, self.no_column)

        pygame.init()
        self.graphicLabyrinth = pygame.display.set_mode((32*self.no_row, 32*self.no_column))

        # Here we load all the images from the folder 'resources'
        os.chdir("../images")
        self.wall = pygame.image.load("wall.jpg").convert()
        self.path = pygame.image.load("path.jpg").convert()
        self.hero = pygame.image.load("macgyver.png").convert_alpha()
        self.guardian = pygame.image.load("guardian.jpg").convert_alpha()
        self.needle = pygame.image.load("needle.png").convert_alpha()
        self.plastic_tube = pygame.image.load("plastic_tube.png").convert_alpha()
        self.ether = pygame.image.load("ether.png").convert_alpha()

        for i in range(self.no_row):
            for j in range(self.no_column):
                if self.labyrinth[i][j] == 'm':
                    self.graphicLab.blit(self.wall, (32*i, 32*j))
                elif self.labyrinth[i][j] == 'o':
                     self.graphicLab.blit(self.path, (32*i, 32*j))
                elif self.labyrinth[i][j] == 'h':
                     self.graphicLab.blit(self.hero, (32*i, 32*j))
                elif self.labyrinth[i][j] == 'v':
                     self.graphicLab.blit(self.guardian, (32*i, 32*j))
                elif self.labyrinth[i][j] == 'n': # n for needle
                    self.graphicLab.blit(self.x, (32*i, 32*j))
                elif self.labyrinth[i][j] == 'p': # p for plastic_tube
                    self.graphicLab.blit(self.x, (32*i, 32*j))
                elif self.labyrinth[i][j] == 'e': # e for ether (and f for fake)
                    self.graphicLab.blit(self.x, (32*i, 32*j))
        # Display of the labyrinth :
        self.graphicLabyrinth.display.flip()


    def place_objects(self, labyrinth, no_row, no_column):
        """Placement of the three objects needed for the victory and the management
        of their counter display"""
        x_true = False
        y_true = False
        z_True = False

        while x_true is False and y_true is False and z_true is False:
            x_abs = random.randint(0, no_row)
            x_ord = random.randint(0, no_column)
            if labyrinth[x_abs][x_ord] == 'o':
                x_true = True
                self.labyrinth[x_abs][x_ord] = 'x'

            y_abs = random.randint(0, no_row)
            y_ord = random.randint(0, no_column)
            if labyrinth[y_abs][y_ord] == 'o':
                y_true = True
                self.labyrinth[y_abs][y_ord] = 'y'

            z_abs = random.randint(0, no_row)
            z_ord = random.randint(0, no_column)
            if labyrinth[z_abs][z_ord] == 'o':
                z_true = True
                self.labyrinth[z_abs][z_ord] = 'z'

        return labyrinth
    def load_labyrinth(self, raw_labyrinth):
        """Generation of a 2d list called labyrinth which will be used
        for track the hero's position"""
        no_row = 0
        no_column = 0
        for letter in raw_labyrinth:
            if letter == "\n":
                no_row += 1
        no_column = len(raw_labyrinth)//no_row
        # strip 'raw_labyrinth' from the line breaks
        raw_labyrinth = raw_labyrinth.replace('\n', '')

        # 'labyrinth' is a 2 dimensions list with 'no_row' rows
        # and 'no_column' columns (here 15*15)
        labyrinth = [ [0]*self.no_column for i in range(self.no_row) ]
        counter = 0
        for i in range(15):
            for j in range(15):
                labyrinth[i][j] = raw_labyrinth[counter]
                counter += 1
        return labyrinth, no_line, no_column
